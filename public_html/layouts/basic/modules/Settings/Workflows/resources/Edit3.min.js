Settings_Workflows_Edit_Js("Settings_Workflows_Edit3_Js",{},{step3Container:false,advanceFilterInstance:false,ckEditorInstance:false,fieldValueMap:false,init:function(){this.initialize()},getContainer:function(){return this.step3Container},setContainer:function(element){this.step3Container=element;return this},initialize:function(container){if(typeof container=="undefined"){container=jQuery("#workflow_step3")}if(container.is("#workflow_step3")){this.setContainer(container)}else{this.setContainer(jQuery("#workflow_step3"))}},registerEditTaskEvent:function(){var thisInstance=this;var container=this.getContainer();App.Fields.Password.registerCopyClipboard();container.on("click","[data-url]",function(e){var currentElement=jQuery(e.currentTarget);var params=currentElement.data("url");var progressIndicatorElement=jQuery.progressIndicator({position:"html",blockInfo:{enabled:true}});app.showModalWindow(null,params,function(data){progressIndicatorElement.progressIndicator({mode:"hide"});thisInstance.registerVTCreateTodoTaskEvents();var taskType=jQuery("#taskType").val();var functionName="register"+taskType+"Events";if(typeof thisInstance[functionName]!="undefined"){thisInstance[functionName].apply(thisInstance)}thisInstance.registerSaveTaskSubmitEvent(taskType);jQuery("#saveTask").validationEngine(app.validationEngineOptions);thisInstance.registerFillTaskFieldsEvent();thisInstance.registerCheckSelectDateEvent();app.showBtnSwitch($(data).find(".switchBtn"));app.showPopoverElementView($(data).find(".js-popover-tooltip"));var contentHeight=parseInt(data.find(".modal-body").height());var maxHeight=app.getScreenHeight(80);if(contentHeight>maxHeight){app.showScrollBar(data.find(".modal-body"),{height:maxHeight+"px"})}})})},registerCheckSelectDateEvent:function(){jQuery('[name="check_select_date"]').on("change",function(e){if(jQuery(e.currentTarget).is(":checked")){jQuery("#checkSelectDateContainer").removeClass("d-none").addClass("show")}else{jQuery("#checkSelectDateContainer").removeClass("show").addClass("d-none")}})},registerSaveTaskSubmitEvent:function(taskType){var thisInstance=this;jQuery("#saveTask").on("submit",function(e){var form=jQuery(e.currentTarget);var validationResult=form.validationEngine("validate");if(validationResult==true){var customValidationFunctionName=taskType+"CustomValidation";if(typeof thisInstance[customValidationFunctionName]!="undefined"){var result=thisInstance[customValidationFunctionName].apply(thisInstance);if(result!=true){var params={title:app.vtranslate("JS_MESSAGE"),text:result,type:"error"};Vtiger_Helper_Js.showPnotify(params);e.preventDefault();return}}var preSaveActionFunctionName="preSave"+taskType;if(typeof thisInstance[preSaveActionFunctionName]!="undefined"){thisInstance[preSaveActionFunctionName].apply(thisInstance,[taskType])}var params=form.serializeFormData();AppConnector.request(params).then(function(data){if(data.result){thisInstance.getTaskList();app.hideModalWindow()}})}e.preventDefault()})},VTUpdateFieldsTaskCustomValidation:function(){return this.checkDuplicateFieldsSelected()},VTCreateEntityTaskCustomValidation:function(){return this.checkDuplicateFieldsSelected()},checkDuplicateFieldsSelected:function(){var selectedFieldNames=jQuery("#save_fieldvaluemapping").find(".conditionRow").find('[name="fieldname"]');var result=true;var failureMessage=app.vtranslate("JS_SAME_FIELDS_SELECTED_MORE_THAN_ONCE");jQuery.each(selectedFieldNames,function(i,ele){var fieldName=jQuery(ele).attr("value");var fields=jQuery("[name="+fieldName+"]").not(":hidden");if(fields.length>1){result=failureMessage;return false}});return result},preSaveVTUpdateFieldsTask:function(tasktype){var values=this.getValues(tasktype);jQuery('[name="field_value_mapping"]').val(JSON.stringify(values))},preSaveVTCreateEntityTask:function(tasktype){var values=this.getValues(tasktype);jQuery('[name="field_value_mapping"]').val(JSON.stringify(values))},preSaveVTEmailTask:function(tasktype){var textAreaElement=jQuery("#content");textAreaElement.val(CKEDITOR.instances["content"].getData())},preSaveVTUpdateRelatedFieldTask:function(tasktype){var values=this.getValues(tasktype);jQuery('[name="field_value_mapping"]').val(JSON.stringify(values))},isEmptyFieldSelected:function(fieldSelect){var selectedOption=fieldSelect.find("option:selected");if(selectedOption.val()=="none"){return true}return false},getVTCreateEntityTaskFieldList:function(){return new Array("fieldname","value","valuetype","modulename")},getVTUpdateFieldsTaskFieldList:function(){return new Array("fieldname","value","valuetype")},getVTUpdateRelatedFieldTaskFieldList:function(){return new Array("fieldname","value","valuetype")},getValues:function(tasktype){var thisInstance=this;var conditionsContainer=jQuery("#save_fieldvaluemapping");var fieldListFunctionName="get"+tasktype+"FieldList";if(typeof thisInstance[fieldListFunctionName]!="undefined"){var fieldList=thisInstance[fieldListFunctionName].apply()}var values=[];var conditions=jQuery(".conditionRow",conditionsContainer);conditions.each(function(i,conditionDomElement){var rowElement=jQuery(conditionDomElement);var fieldSelectElement=jQuery('[name="fieldname"]',rowElement);var valueSelectElement=jQuery('[data-value="value"]',rowElement);if(thisInstance.isEmptyFieldSelected(fieldSelectElement)){return true}var fieldDataInfo=fieldSelectElement.find("option:selected").data("fieldinfo");var fieldType=fieldDataInfo.type;var rowValues={};if(fieldType=="owner"){for(var key in fieldList){var field=fieldList[key];if(field=="value"&&valueSelectElement.is("select")){rowValues[field]=valueSelectElement.find("option:selected").val()}else{rowValues[field]=jQuery('[name="'+field+'"]',rowElement).val()}}}else if(fieldType=="picklist"||fieldType=="multipicklist"){for(var key in fieldList){var field=fieldList[key];if(field=="value"&&valueSelectElement.is("input")){var commaSeperatedValues=valueSelectElement.val();var pickListValues=valueSelectElement.data("picklistvalues");var valuesArr=commaSeperatedValues.split(",");var newvaluesArr=[];for(i=0;i<valuesArr.length;i++){if(typeof pickListValues[valuesArr[i]]!="undefined"){newvaluesArr.push(pickListValues[valuesArr[i]])}else{newvaluesArr.push(valuesArr[i])}}var reconstructedCommaSeperatedValues=newvaluesArr.join(",");rowValues[field]=reconstructedCommaSeperatedValues}else if(field=="value"&&valueSelectElement.is("select")&&fieldType=="picklist"){rowValues[field]=valueSelectElement.val()}else if(field=="value"&&valueSelectElement.is("select")&&fieldType=="multipicklist"){var value=valueSelectElement.val();if(value==null){rowValues[field]=value}else{rowValues[field]=value.join(",")}}else{rowValues[field]=jQuery('[name="'+field+'"]',rowElement).val()}}}else{for(var key in fieldList){var field=fieldList[key];if(field=="value"){rowValues[field]=valueSelectElement.val()}else{rowValues[field]=jQuery('[name="'+field+'"]',rowElement).val()}}}if(jQuery('[name="valuetype"]',rowElement).val()=="false"||jQuery('[name="valuetype"]',rowElement).length==0){rowValues["valuetype"]="rawtext"}values.push(rowValues)});return values},getTaskList:function(){var container=this.getContainer();var params={module:app.getModuleName(),parent:app.getParentModuleName(),view:"TasksList",record:jQuery('[name="record"]',container).val()};var progressIndicatorElement=jQuery.progressIndicator({position:"html",blockInfo:{enabled:true}});AppConnector.request(params).then(function(data){jQuery("#taskListContainer").html(data);progressIndicatorElement.progressIndicator({mode:"hide"})})},getckEditorInstance:function(){if(this.ckEditorInstance==false){this.ckEditorInstance=new Vtiger_CkEditor_Js}return this.ckEditorInstance},registerTaskStatusChangeEvent:function(){var container=this.getContainer();container.on("change",".taskStatus",function(e){var currentStatusElement=jQuery(e.currentTarget);var url=currentStatusElement.data("statusurl");if(currentStatusElement.is(":checked")){url=url+"&status=true"}else{url=url+"&status=false"}var progressIndicatorElement=jQuery.progressIndicator({position:"html",blockInfo:{enabled:true}});AppConnector.request(url).then(function(data){if(data.result=="ok"){var params={title:app.vtranslate("JS_MESSAGE"),text:app.vtranslate("JS_STATUS_CHANGED_SUCCESSFULLY"),type:"success"};Vtiger_Helper_Js.showPnotify(params)}progressIndicatorElement.progressIndicator({mode:"hide"})});e.stopImmediatePropagation()})},registerTaskDeleteEvent:function(){var thisInstance=this;var container=this.getContainer();container.on("click",".deleteTask",function(e){var message=app.vtranslate("LBL_DELETE_CONFIRMATION");Vtiger_Helper_Js.showConfirmationBox({message:message}).then(function(){var currentElement=jQuery(e.currentTarget);var deleteUrl=currentElement.data("deleteurl");AppConnector.request(deleteUrl).then(function(data){if(data.result=="ok"){thisInstance.getTaskList();var params={title:app.vtranslate("JS_MESSAGE"),text:app.vtranslate("JS_TASK_DELETED_SUCCESSFULLY"),type:"success"};Vtiger_Helper_Js.showPnotify(params)}})})})},registerFillTaskFromEmailFieldEvent:function(){jQuery("#saveTask").on("change","#fromEmailOption",function(e){var currentElement=jQuery(e.currentTarget);var inputElement=currentElement.closest(".row").find(".fields");inputElement.val(currentElement.val())})},registerFillTaskFieldsEvent:function(){jQuery("#saveTask").on("change",".task-fields",function(e){var currentElement=jQuery(e.currentTarget);var inputElement=currentElement.closest(".row").find(".fields");var oldValue=inputElement.val();var newValue=oldValue+currentElement.val();inputElement.val(newValue)})},registerFillMailContentEvent:function(){jQuery("#task-fieldnames,#task_timefields,#task-templates").on("change",function(e){var textarea=CKEDITOR.instances.content;var value=jQuery(e.currentTarget).val();if(textarea!=undefined){textarea.insertHtml(value)}else if(jQuery('textarea[name="content"]')){var textArea=jQuery('textarea[name="content"]');textArea.insertAtCaret(value)}})},registerVTEmailTaskEvents:function(){var textAreaElement=jQuery("#content");var ckEditorInstance=this.getckEditorInstance();ckEditorInstance.loadCkEditor(textAreaElement);this.registerFillMailContentEvent();this.registerFillTaskFromEmailFieldEvent();this.registerCcAndBccEvents()},registerVTCreateTodoTaskEvents:function(){app.registerEventForClockPicker()},registerVTUpdateFieldsTaskEvents:function(){var thisInstance=this;this.registerAddFieldEvent();this.registerDeleteConditionEvent();this.registerFieldChange();this.fieldValueMap=false;if(jQuery("#fieldValueMapping").val()!=""){this.fieldValueReMapping()}var fields=jQuery("#save_fieldvaluemapping").find('select[name="fieldname"]');jQuery.each(fields,function(i,field){thisInstance.loadFieldSpecificUi(jQuery(field))});this.getPopUp(jQuery("#saveTask"))},registerVTUpdateRelatedFieldTaskEvents:function(){var thisInstance=this;this.registerAddFieldEvent();this.registerDeleteConditionEvent();this.registerFieldChange();this.fieldValueMap=false;if(jQuery("#fieldValueMapping").val()!=""){this.fieldValueReMapping()}var fields=jQuery("#save_fieldvaluemapping").find('select[name="fieldname"]');jQuery.each(fields,function(i,field){thisInstance.loadFieldSpecificUi(jQuery(field))});this.getPopUp(jQuery("#saveTask"))},registerAddFieldEvent:function(){jQuery("#addFieldBtn").on("click",function(e){var newAddFieldContainer=jQuery(".basicAddFieldContainer").clone(true,true).removeClass("basicAddFieldContainer d-none").addClass("conditionRow");jQuery("select",newAddFieldContainer).addClass("select2");jQuery("#save_fieldvaluemapping").append(newAddFieldContainer);App.Fields.Picklist.changeSelectElementView(newAddFieldContainer);App.Fields.Picklist.showSelect2ElementView(newAddFieldContainer.find(".select2"))})},registerDeleteConditionEvent:function(){jQuery("#saveTask").on("click",".deleteCondition",function(e){jQuery(e.currentTarget).closest(".conditionRow").remove()})},registerFieldChange:function(){var thisInstance=this;jQuery("#saveTask").on("change",'select[name="fieldname"]',function(e){var selectedElement=jQuery(e.currentTarget);if(selectedElement.val()!="none"){var conditionRow=selectedElement.closest(".conditionRow");var moduleNameElement=conditionRow.find('[name="modulename"]');if(moduleNameElement.length>0){var selectedOptionFieldInfo=selectedElement.find("option:selected").data("fieldinfo");var type=selectedOptionFieldInfo.type;if(type=="picklist"||type=="multipicklist"){var selectElement=jQuery("select.createEntityModule:not(:disabled)");var moduleName=selectElement.val();moduleNameElement.val(moduleName).change().prop("disabled",true)}}thisInstance.loadFieldSpecificUi(selectedElement)}})},getModuleName:function(){return app.getModuleName()},getFieldValueMapping:function(){var fieldValueMap=this.fieldValueMap;if(fieldValueMap!=false){return fieldValueMap}else{return""}},fieldValueReMapping:function(){var object=JSON.parse(jQuery("#fieldValueMapping").val());var fieldValueReMap={};jQuery.each(object,function(i,array){fieldValueReMap[array.fieldname]={};var values={};jQuery.each(array,function(key,value){values[key]=value});fieldValueReMap[array.fieldname]=values});this.fieldValueMap=fieldValueReMap},loadFieldSpecificUi:function(fieldSelect){var selectedOption=fieldSelect.find("option:selected");var row=fieldSelect.closest("div.conditionRow");var fieldUiHolder=row.find(".fieldUiHolder");var fieldInfo=selectedOption.data("fieldinfo");var fieldValueMapping=this.getFieldValueMapping();var selectField="";if(fieldValueMapping&&typeof fieldValueMapping[fieldInfo.name]!="undefined"){selectField=fieldValueMapping[fieldInfo.name]}else if(fieldValueMapping&&typeof fieldValueMapping[fieldSelect.val()]!="undefined"){selectField=fieldValueMapping[fieldSelect.val()]}if(selectField){fieldInfo.value=selectField["value"];fieldInfo.workflow_valuetype=selectField["valuetype"]}else{fieldInfo.workflow_valuetype="rawtext"}var moduleName=this.getModuleName();var fieldModel=Vtiger_Field_Js.getInstance(fieldInfo,moduleName);this.fieldModelInstance=fieldModel;var fieldSpecificUi=this.getFieldSpecificUi(fieldSelect);var fieldName=fieldModel.getName();if(fieldModel.getType()=="multipicklist"){fieldName=fieldName+"[]"}fieldSpecificUi.filter('[name="'+fieldName+'"]').attr("data-value","value");fieldSpecificUi.find('[name="'+fieldName+'"]').attr("data-value","value");fieldSpecificUi.filter('[name="valuetype"]').removeAttr("data-validation-engine");fieldSpecificUi.find('[name="valuetype"]').removeAttr("data-validation-engine");var workflowValueType=fieldSpecificUi.filter('[name="valuetype"]').val();if(workflowValueType!="rawtext"&&typeof workflowValueType!="undefined"){fieldSpecificUi.filter('[name="'+fieldName+'"]').removeAttr("data-validation-engine");fieldSpecificUi.find('[name="'+fieldName+'"]').removeAttr("data-validation-engine")}fieldUiHolder.html(fieldSpecificUi);if(fieldSpecificUi.is("input.select2")){var tagElements=fieldSpecificUi.data("tags");var params={tags:tagElements,tokenSeparators:[","]};App.Fields.Picklist.showSelect2ElementView(fieldSpecificUi,params)}else if(fieldSpecificUi.is("select")){if(fieldSpecificUi.hasClass("chzn-select")){App.Fields.Picklist.changeSelectElementView(fieldSpecificUi)}else{App.Fields.Picklist.showSelect2ElementView(fieldSpecificUi)}}else if(fieldSpecificUi.is("input.dateField")){App.Fields.Date.register(fieldSpecificUi)}else if(fieldSpecificUi.is("input.dateRangeField")){App.Fields.Date.registerRange(fieldSpecificUi,{ranges:false})}return this},getFieldSpecificUi:function(fieldSelectElement){var fieldModel=this.fieldModelInstance;return jQuery(fieldModel.getUiTypeSpecificHtml())},registerVTCreateEventTaskEvents:function(){app.registerEventForClockPicker()},registerVTCreateEntityTaskEvents:function(){this.registerChangeCreateEntityEvent();this.registerVTUpdateFieldsTaskEvents()},registerChangeCreateEntityEvent:function(){var thisInstance=this;jQuery('[name="mappingPanel"]').on("change",function(e){var currentTarget=jQuery(e.currentTarget);app.setMainParams("mappingPanel",currentTarget.val());jQuery("#addCreateEntityContainer").html("");var hideElementByClass=jQuery("."+currentTarget.data("hide"));var showElementByClass=jQuery("."+currentTarget.data("show"));var taskFields=app.getMainParams("taskFields",true);hideElementByClass.addClass("d-none").find("input,select").each(function(e,n){var element=jQuery(this);var name=element.attr("name");if($.inArray(name,taskFields)>=0){if(element.is("select")){element.val("").trigger("chosen:updated").change()}element.prop("disabled",true)}});showElementByClass.removeClass("d-none").find("input,select").each(function(e,n){var element=jQuery(this);var name=element.attr("name");if($.inArray(name,taskFields)>=0){element.prop("disabled",false);if(element.is("select")){element.val("").trigger("chosen:updated").change()}}})});jQuery(".createEntityModule").on("change",function(e){var params={module:app.getModuleName(),parent:app.getParentModuleName(),view:"CreateEntity",for_workflow:jQuery('[name="for_workflow"]').val(),mappingPanel:app.getMainParams("mappingPanel")};var relatedModule=jQuery(e.currentTarget).val();if(relatedModule){params["relatedModule"]=relatedModule}var progressIndicatorElement=jQuery.progressIndicator({position:"html",blockInfo:{enabled:true}});AppConnector.request(params).then(function(data){progressIndicatorElement.progressIndicator({mode:"hide"});var createEntityContainer=jQuery("#addCreateEntityContainer");createEntityContainer.html(data);App.Fields.Picklist.changeSelectElementView(createEntityContainer);App.Fields.Picklist.showSelect2ElementView(createEntityContainer.find(".select2"));thisInstance.registerAddFieldEvent();thisInstance.fieldValueMap=false;if(jQuery("#fieldValueMapping").val()!=""){this.fieldValueReMapping()}var fields=jQuery("#save_fieldvaluemapping").find('select[name="fieldname"]');jQuery.each(fields,function(i,field){thisInstance.loadFieldSpecificUi(jQuery(field))})})})},changeRecurringTypesUIStyles:function(recurringType){var thisInstance=this;if(recurringType=="Daily"||recurringType=="Yearly"){jQuery("#repeatWeekUI").removeClass("show").addClass("d-none");jQuery("#repeatMonthUI").removeClass("show").addClass("d-none")}else if(recurringType=="Weekly"){jQuery("#repeatWeekUI").removeClass("d-none").addClass("show");jQuery("#repeatMonthUI").removeClass("show").addClass("d-none")}else if(recurringType=="Monthly"){jQuery("#repeatWeekUI").removeClass("show").addClass("d-none");jQuery("#repeatMonthUI").removeClass("d-none").addClass("show")}},checkHiddenStatusofCcandBcc:function(){var ccLink=jQuery("#ccLink");var bccLink=jQuery("#bccLink");if(ccLink.hasClass("d-none")&&bccLink.hasClass("d-none")){ccLink.closest("div.row").addClass("d-none")}},registerCcAndBccEvents:function(){var thisInstance=this;jQuery("#ccLink").on("click",function(e){var ccContainer=jQuery("#ccContainer");ccContainer.removeClass("d-none");var taskFieldElement=ccContainer.find("select.task-fields");taskFieldElement.addClass("chzn-select");App.Fields.Picklist.changeSelectElementView(taskFieldElement);jQuery(e.currentTarget).addClass("d-none");thisInstance.checkHiddenStatusofCcandBcc()});jQuery("#bccLink").on("click",function(e){var bccContainer=jQuery("#bccContainer");bccContainer.removeClass("d-none");var taskFieldElement=bccContainer.find("select.task-fields");taskFieldElement.addClass("chzn-select");App.Fields.Picklist.changeSelectElementView(taskFieldElement);jQuery(e.currentTarget).addClass("d-none");thisInstance.checkHiddenStatusofCcandBcc()})},registerEvents:function(){var container=this.getContainer();App.Fields.Picklist.changeSelectElementView(container);this.registerEditTaskEvent();this.registerTaskStatusChangeEvent();this.registerTaskDeleteEvent()}});jQuery.fn.extend({insertAtCaret:function(myValue){return this.each(function(i){if(document.selection){this.focus();var sel=document.selection.createRange();sel.text=myValue;this.focus()}else if(this.selectionStart||this.selectionStart=="0"){var startPos=this.selectionStart;var endPos=this.selectionEnd;var scrollTop=this.scrollTop;this.value=this.value.substring(0,startPos)+myValue+this.value.substring(endPos,this.value.length);this.focus();this.selectionStart=startPos+myValue.length;this.selectionEnd=startPos+myValue.length;this.scrollTop=scrollTop}else{this.value+=myValue;this.focus()}})}});